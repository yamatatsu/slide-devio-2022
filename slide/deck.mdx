import { Notes, Head, Steps } from "mdx-deck";
import { CodeSurferLayout, vsDarkPartial } from "code-surfer";
import { Meta, Profile, AlignLeft, Header, TitleBackground, NormalBackground } from "./parts";
import "main.css";

export const theme = vsDarkPartial;

<Head>
  <Meta
    title="AWS CDK ã§ AWS App Runner"
    description="AWS CDK ã§ AWS App Runner"
    publishedAt={"2022-06-06T15:00:51.470Z"}
    host="https://yamatatsu.github.io/slide-devio-2022"
  />
</Head>

<TitleBackground>

<p></p>
<p></p>
<p></p>

# AWS CDK ã§ AWS App Runner

DevelopersIO 2022

@yamatatsu

</TitleBackground>

---
<NormalBackground>

<AlignLeft>

<Header>About Me</Header>

<Profile />

</AlignLeft>

</NormalBackground>

---
<NormalBackground>

ã“ã®ç™»å£‡ã®ç‹™ã„

</NormalBackground>

---
<NormalBackground>

<Header>ã“ã®ç™»å£‡ã®ç‹™ã„</Header>

![](./parts/assets/using-cdk.png)

</NormalBackground>

---
<NormalBackground>

<Header>ã“ã®ç™»å£‡ã®ç‹™ã„</Header>

### ã“ã®ç™»å£‡ã®ç‹™ã„

- CDKãƒ“ã‚®ãƒŠãƒ¼å‘ã‘ã®è©±ã«ã—ã‚ˆã†
- æ“¬ä¼¼çš„ã«CDKã‚’ä½“é¨“ã§ãã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã—ã‚ˆã†

</NormalBackground>

---
<NormalBackground>

### ç›®æ¬¡

- cdk init ã—ã¦ã¿ã‚‹
- App Runner ã—ã¦ã¿ã‚‹
- VPC ã—ã¦ã¿ã‚‹
- RDS ã—ã¦ã¿ã‚‹
- Bastion ã—ã¦ã¿ã‚‹
- route53 ã¨ ACM ã—ã¦ã¿ã‚‹
- Tips: DB migraion ã‚’è‡ªå‹•åŒ–ã™ã‚‹

</NormalBackground>

---
<NormalBackground>

å‰æ
- node: v16
- npm: v8

</NormalBackground>

---
<NormalBackground>

# cdk init ã—ã¦ã¿ã‚‹

</NormalBackground>

---
<CodeSurferLayout>

```bash subtitle="ã¾ãšã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ˜ã£ã¦ã€initã‚’å”±ãˆã¾ã™"
# terminal ã«ã¦

mkdir playground-cdk
cd playground-cdk

npx cdk init app --language=typescript
```

```text subtitle="ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ˆç°¡å˜ã®ãŸã‚å†…å®¹ã‚’æŠœç²‹ã—ã¦ã„ã¾ã™ï¼‰"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 5 subtitle="ã¾ãšã¯cdk.jsonã‹ã‚‰è¦‹ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```json subtitle="jsonã®\"app\"ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™"
{
  "app": "npx ts-node --prefer-ts-exts bin/playground-cdk.ts",
  // çœç•¥
}
```

```json 2[15:21,40:60] subtitle="ts-nodeã‚’ä½¿ã£ã¦bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™"
{
  "app": "npx ts-node --prefer-ts-exts bin/playground-cdk.ts",
  // çœç•¥
}
```

```text subtitle="ã¾ãŸdirãƒ„ãƒªãƒ¼ã«æˆ»ã‚Šã¾ã—ã¦"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 1:2 subtitle="ä»Šåº¦ã¯binã®ä¸­èº«ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```ts subtitle="bin/playground-cdk.tsã®ä¸­èº«ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™"
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 1 subtitle="ts-nodeã§å®Ÿè¡Œã™ã‚‹ã®ã«shebangãŒç€ã„ã¦ã„ã¾ã™"
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts subtitle="ã„ã‚‰ãªã„ã—misleadãªã®ã§æ¶ˆã—ã¾ã™"
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 1 subtitle="æ¬¡ã«ã€ts-nodeã§å®Ÿè¡Œã™ã‚‹ã®ã«source-map-supportãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™"
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts subtitle="ã„ã‚‰ãªã„ã®ã§æ¶ˆã—ã¾ã™"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 1:7 subtitle="å°‘ã—ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸ"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 2,5 subtitle="ã“ã®binãƒ•ã‚¡ã‚¤ãƒ«ã®ã—ã”ã¨ã¯stackã‚’å®šç¾©ã—ã¦ã„ãã“ã¨ã§ã™"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```text subtitle="ã¾ãŸã‚‚dirãƒ„ãƒªãƒ¼ã«æˆ»ã‚Šã¾ã—ã¦"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 3:4 subtitle="ä»Šåº¦ã¯binã§å‚ç…§ã•ã‚Œã¦ã„ãŸlibã®ä¸­èº«ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```ts subtitle="lib/playground-cdk-stack.tsã®ä¸­èº«ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
// import * as sqs from 'aws-cdk-lib/aws-sqs';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // çœç•¥
  }
}
```

```ts subtitle="ã„ã‚ã„ã‚è§£èª¬"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as sqs from 'aws-cdk-lib/aws-sqs';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // çœç•¥
  }
}
```

```ts subtitle="ã„ã‚ã„ã‚è§£èª¬"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as sqs from 'aws-cdk-lib/aws-sqs';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    new sqs.Queue(this, 'MyQueue', {
      fifo: true
    })
  }
}
```

```text subtitle="ã¾ãŸã¾ãŸdirãƒ„ãƒªãƒ¼ã«æˆ»ã‚Šã¾ã—ã¦"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 6 subtitle="æœ€å¾Œã«package.jsonã®ä¸­èº«ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

</CodeSurferLayout>

---
<CodeSurferLayout>

```json subtitle="ã“ã¡ã‚‰ãŒpackage.jsonã®ä¸­èº«ã§ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "bin": {
    "playground-cdk": "bin/playground-cdk.js"
  },
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 4:6 subtitle="binã®å®šç¾©ãŒã‚ã‚Šã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "bin": {
    "playground-cdk": "bin/playground-cdk.js"
  },
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json subtitle="ã„ã‚‰ãªã„ã®ã§æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 5:6 subtitle="tscã‚’ä½¿ã†scriptãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json subtitle="ã„ã‚‰ãªã„ã®ã§æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 6 subtitle="cdkã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json subtitle="npm run cdk -- deploy ã‚ˆã‚Šã‚‚ npx cdk deploy ã‚’ä½¿ã†ã®ã§æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 20 subtitle="å…ˆç¨‹ä½¿ã‚ãªããªã£ãŸsource-map-supportã‚‚"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 20 subtitle="æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0"
  }
}
```

```json 1:21 subtitle="ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸ"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0"
  }
}
```

</CodeSurferLayout>

---
<NormalBackground>

ä»¥ä¸Šã€åƒ•ãŒ init ã—ãŸã¨ãã«ã„ã¤ã‚‚ã‚„ã‚‹ä½œæ¥­ã§ã—ãŸ

- issueã‚’ç«‹ã¦ã¦ã¾ã™
- æ°—ãŒå‘ã„ãŸã‚‰ ts-node ã‚’  
  esbuild-register ã«ç½®ãæ›ãˆãŸã‚Šã‚‚ã—ã¾ã™

</NormalBackground>

---
<NormalBackground>

### ç›®æ¬¡

- ~~cdk init ã—ã¦ã¿ã‚‹~~
- App Runner ã—ã¦ã¿ã‚‹
- VPC ã—ã¦ã¿ã‚‹
- RDS ã—ã¦ã¿ã‚‹
- Bastion ã—ã¦ã¿ã‚‹
- DB migraion ã—ã¦ã¿ã‚‹
- route53 ã¨ ACM ã—ã¦ã¿ã‚‹
- å°ãƒã‚¿ `environment-agnostic` ã®ãƒ¡ãƒªãƒ‡ãƒ¡

</NormalBackground>

---
<NormalBackground>

# App Runner ã—ã¦ã¿ã‚‹

</NormalBackground>

---
<CodeSurferLayout>

```bash subtitle="aws-apprunner-alpha ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™"
# terminal ã«ã¦

npm i -S @aws-cdk/aws-apprunner-alpha
```

```ts subtitle="ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ã¦ã‚‹ lib/playground-cdk-stack.ts ã‚’"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
// import * as sqs from 'aws-cdk-lib/aws-sqs';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // çœç•¥
  }
}
```

```ts subtitle="ã“ã†ã—ã¦"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // çœç•¥
  }
}
```

```ts subtitle="ã“ã†ã—ã¦"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });
  }
}
```

```ts subtitle="ã“ã†ã˜ã‚ƒ"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts subtitle="cpuã‚„memoryã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
      cpu: apprunner.Cpu.TWO_VCPU,
      memory: apprunner.Memory.FOUR_GB,
    });
  }
}
```

```bash subtitle="ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã—ã‚‡ã†"
# terminal ã«ã¦

npx cdk deploy
```

```bash subtitle="èµ·å‹•ã—ãŸã‚‰ç–é€šã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚"
# terminal ã«ã¦

curl https://xxxxxxxxxx.ap-northeast-1.awsapprunner.com
# OK
```

</CodeSurferLayout>

---
<NormalBackground>

<Header>App Runner ã—ã¦ã¿ã‚‹</Header>

### ã¾ã¨ã‚

- App Runner ä¾¿åˆ©ï¼

</NormalBackground>

---
<NormalBackground>

# VPC ã—ã¦ã¿ã‚‹

</NormalBackground>

---
<NormalBackground>

<Header>VPC ã—ã¦ã¿ã‚‹</Header>

![](./parts/assets/press-of-vpc-connector.png)

</NormalBackground>

---
<CodeSurferLayout>

```ts subtitle="å…ˆç¨‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts subtitle="VPCã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts 11:12 subtitle="ä¸€æ—¦ã€ã“ã‚Œã§ä½œæˆãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

</CodeSurferLayout>

---
<NormalBackground>

![](./parts/assets/vpc-agnostic.png)

</NormalBackground>

---
<NormalBackground>

# ğŸ¤”

</NormalBackground>

---
<CodeSurferLayout>

```ts 11:12
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts 11:13 subtitle="maxAzsã‚’è¶³ã—ã¦ã¿ã¾ã—ã‚‡ã†"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
      maxAzs: 3,
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

</CodeSurferLayout>

---
<NormalBackground>

![](./parts/assets/vpc-agnostic.png)

</NormalBackground>

---
<NormalBackground>

# ğŸ¤”

</NormalBackground>

---
<NormalBackground>

![](./parts/assets/jsdoc-vpc-maxAzs.png)

</NormalBackground>

---
<CodeSurferLayout>

```ts 5:7 subtitle="binãƒ•ã‚¡ã‚¤ãƒ«ã«ã¦"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 5:10 subtitle="envã¨ã—ã¦accountã¨regionã‚’æŒ‡å®šã—ã¦ã‚ã’ã¾ã™ã€‚"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  env: {
    account: "123456789012",
    region: "ap-northeast-1",
  },
});
```

</CodeSurferLayout>

---
<NormalBackground>

![](./parts/assets/vpc-env-specified.png)

å…¬å¼Doc: https://docs.aws.amazon.com/cdk/v2/guide/environments.html

</NormalBackground>

---
<NormalBackground>

# ğŸ‰

</NormalBackground>

---
<NormalBackground>

![](./parts/assets/vpc-env-specified.png)

</NormalBackground>

---
<NormalBackground>

![](./parts/assets/vpc-env-specified-nat.png)

</NormalBackground>

---
<NormalBackground>

- `new VPC()` ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Nat Gatewayã‚’ä½œã£ã¦ãã‚Œã‚‹
- åˆã‚ã¦CDKè§¦ã£ãŸäººã«3AZã§3å°Nat Gatewayã‚’ä½œã£ã¦ãã‚Œã‚‹
- Nat Gateway 1å° 0.062 USD/hour
  - 0.062 \* 3 \* 24 \* 30 \* 135.99 = 18,212å††/æœˆãã‚‰ã„

</NormalBackground>

---
<CodeSurferLayout>

```ts 11:12
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts subtitle="natGatewayProviderã«ã¦nat instanceã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
      natGatewayProvider: ec2.NatProvider.instance({
        instanceType: ec2.InstanceType.of(
          ec2.InstanceClass.T3,
          ec2.InstanceSize.NANO
        ),
      }),
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts subtitle="natGatewaysã«0ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€Nat Gatewayã¨Instanceã®ä¸¡æ–¹ã‚’ä½œæˆã—ãªã„è¨­å®šã‚‚ã§ãã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
      natGateways: 0,
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts subtitle="VPCã¯Subnetæ§‹æˆã‚‚æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
      natGateways: 0,
      subnetConfiguration: [
        { name: "public-subnet", subnetType: ec2.SubnetType.PUBLIC },
        { name: "app-subnet", subnetType: ec2.SubnetType.PRIVATE_WITH_NAT },
        { name: "db-subnet", subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
      ],
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts 13:16 subtitle="ä»Šå›ã¯å¤–éƒ¨APIã‚’ä½¿ã†è¦ä»¶ã¯ç„¡ã„ã“ã¨ã«ã—ã¦ã€ISOLATEDã‚’2ã¤ç”¨æ„ã—ã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
      natGateways: 0,
      subnetConfiguration: [
        { name: "app-subnet", subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
        { name: "db-subnet", subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
      ],
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts 11:17 subtitle=""
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
      natGateways: 0,
      subnetConfiguration: [
        { name: "app-subnet", subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
        { name: "db-subnet", subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
      ],
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
    });
  }
}
```

```ts subtitle="VpcConnectorã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§VPCã¨App Runnerã‚’ç¹‹ãã“ã¨ãŒã§ãã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from "aws-cdk-lib/aws-ec2";
import * as assets from "aws-cdk-lib/aws-ecr-assets";
import * as apprunner from '@aws-cdk/aws-apprunner-alpha';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const vpc = new ec2.Vpc(this, "Vpc", {
      natGateways: 0,
      subnetConfiguration: [
        { name: "app-subnet", subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
        { name: "db-subnet", subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
      ],
    });

    const vpcConnector = new apprunner.VpcConnector(this, "VpcConnector", {
      vpc,
      vpcSubnets: { subnetGroupName: "app-subnet" },
    });

    const asset = new assets.DockerImageAsset(this, "ImageAssets", {
      directory: "./app",
      platform: assets.Platform.LINUX_AMD64,
    });

    new apprunner.Service(this, "Service", {
      source: apprunner.Source.fromAsset({
        asset: asset,
        imageConfiguration: {
          port: 3000,
        },
      }),
      vpcConnector,
    });
  }
}
```

</CodeSurferLayout>


---
<NormalBackground>

<Header>VPC ã—ã¦ã¿ã‚‹</Header>

### ã¾ã¨ã‚

- stackã‚’å®šç¾©ã™ã‚‹éš›ã«envã‚’æŒ‡å®šã—ã‚ˆã†
- 3ç¨®é¡ã®SubnetTypeã‚’ä½¿ã„åˆ†ã‘ã‚ˆã†
- NatProviderã‚’é¸ã¼ã†

</NormalBackground>
