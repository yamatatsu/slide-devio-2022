import { Notes, Head, Steps } from "mdx-deck";
import { CodeSurferLayout, vsDarkPartial } from "code-surfer";
import { Meta, Profile, AlignLeft, Header, Mermaid } from "./parts";
import "main.css";

export const theme = vsDarkPartial;

<Head>
  <Meta
    title="CDKã®Tips"
    description="CDKã®Tips"
    publishedAt={"2022-06-06T15:00:51.470Z"}
    host="https://yamatatsu.github.io/slide-devio-2022"
  />
</Head>

# CDKã®Tips

DevelopersIO 2022

@yamatatsu

---
<AlignLeft>

<Header>About Me</Header>

<Profile />

</AlignLeft>

---
ã“ã®ç™»å£‡ã®ç‹™ã„

---
<Header>ã“ã®ç™»å£‡ã®ç‹™ã„</Header>

æœ€åˆ

- ã‚ã£ã¡ã‚ƒDeepãªCDKã®è©±ã—ã—ã¦ãƒ‰ãƒ¤ã‚ŠãŸã„
- CDKã«ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã—ãŸè©±ã—ã—ã¦ãƒ‰ãƒ¤ã‚ŠãŸã„
- æ‰¿èªæ¬²æ±‚ã‚’æº€ãŸã—ãŸã„
- ãƒ‰ãƒ¤ã‚ŠãŸã„

---
<Header>ã“ã®ç™»å£‡ã®ç‹™ã„</Header>

![](./parts/assets/using-cdk.png)

---
<Header>ã“ã®ç™»å£‡ã®ç‹™ã„</Header>

ã¾ã—ã¦ã‚„CDKãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘  
ã§ã‚‚ãªã„ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ªãƒ©ã¤ã„ã¦ã‚‚  
èª°ã‚‚æ±‚ã‚ã¦ãªã„ã‹ã‚‚ğŸ¤”

---
<Header>ã“ã®ç™»å£‡ã®ç‹™ã„</Header>

- ã‚‚ã†ã¡ã‚‡ã„CDKãƒ“ã‚®ãƒŠãƒ¼å‘ã‘ã®è©±ã«ã—ã‚ˆã†
- æ“¬ä¼¼çš„ã«CDKã‚’ä½“é¨“ã§ãã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã—ã‚ˆã†

---
# ã“ã“ã§æ”¹ã‚ã¦ã‚¿ã‚¤ãƒˆãƒ«

---
### ç›®æ¬¡

- cdk init ã—ã¦ã¿ã‚‹
- App Runner ã—ã¦ã¿ã‚‹
- VPC ã—ã¦ã¿ã‚‹
- RDS ã—ã¦ã¿ã‚‹
- DB migraion ã—ã¦ã¿ã‚‹
- route53 ã¨ ACM ã—ã¦ã¿ã‚‹

<!-- 
- `environment-agnostic` ã®ãƒ¡ãƒªãƒ‡ãƒ¡
- TypeScriptã§ã®ç’°å¢ƒå€¤ã®ç®¡ç†
- VPC
- Fargate, ALB
- RDS
- ACM, Route53
- GitHub Actions -->

---
å‰æ
- node: v16
- npm: v8

---
<CodeSurferLayout>

```bash subtitle="ã¾ãšã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ˜ã£ã¦ã€initã‚’å”±ãˆã¾ã™"
# terminal

mkdir playground-cdk
cd playground-cdk

npx cdk init app --language=typescript
```

```text subtitle="ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ˆç°¡å˜ã®ãŸã‚å†…å®¹ã‚’æŠœç²‹ã—ã¦ã„ã¾ã™ï¼‰"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 5 subtitle="ã¾ãšã¯cdk.jsonã‹ã‚‰è¦‹ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```json subtitle="jsonã®\"app\"ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™"
{
  "app": "npx ts-node --prefer-ts-exts bin/playground-cdk.ts",
  // çœç•¥
}
```

```json 2[15:21,40:60] subtitle="ts-nodeã‚’ä½¿ã£ã¦bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™"
{
  "app": "npx ts-node --prefer-ts-exts bin/playground-cdk.ts",
  // çœç•¥
}
```

```text subtitle="ã¾ãŸdirãƒ„ãƒªãƒ¼ã«æˆ»ã‚Šã¾ã—ã¦"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 1:2 subtitle="ä»Šåº¦ã¯binã®ä¸­èº«ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```ts subtitle="bin/playground-cdk.tsã®ä¸­èº«ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™"
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 1 subtitle="ts-nodeã§å®Ÿè¡Œã™ã‚‹ã®ã«shebangãŒç€ã„ã¦ã„ã¾ã™"
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts subtitle="ã„ã‚‰ãªã„ã—misleadãªã®ã§æ¶ˆã—ã¾ã™"
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 1 subtitle="æ¬¡ã«ã€ts-nodeã§å®Ÿè¡Œã™ã‚‹ã®ã«source-map-supportãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™"
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts subtitle="ã„ã‚‰ãªã„ã®ã§æ¶ˆã—ã¾ã™"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 1:7 subtitle="å°‘ã—ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸ"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```ts 2,5 subtitle="ã“ã®binãƒ•ã‚¡ã‚¤ãƒ«ã®ã—ã”ã¨ã¯stackã‚’å®šç¾©ã—ã¦ã„ãã“ã¨ã§ã™"
import * as cdk from 'aws-cdk-lib';
import { PlaygroundAwsCdkStack } from '../lib/playground-cdk-stack';

const app = new cdk.App();
new PlaygroundAwsCdkStack(app, 'PlaygroundAwsCdkStack', {
  // çœç•¥
});
```

```text subtitle="ã¾ãŸã‚‚dirãƒ„ãƒªãƒ¼ã«æˆ»ã‚Šã¾ã—ã¦"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 3:4 subtitle="ä»Šåº¦ã¯binã§å‚ç…§ã•ã‚Œã¦ã„ãŸlibã®ä¸­èº«ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```ts subtitle="lib/playground-cdk-stack.tsã®ä¸­èº«ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
// import * as sqs from 'aws-cdk-lib/aws-sqs';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // çœç•¥
  }
}
```

```ts subtitle="ã„ã‚ã„ã‚è§£èª¬"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as sqs from 'aws-cdk-lib/aws-sqs';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // çœç•¥
  }
}
```

```ts subtitle="ã„ã‚ã„ã‚è§£èª¬"
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as sqs from 'aws-cdk-lib/aws-sqs';

export class PlaygroundCdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    new sqs.Queue(this, 'MyQueue', {
      fifo: true
    })
  }
}
```

```text subtitle="ã¾ãŸã¾ãŸdirãƒ„ãƒªãƒ¼ã«æˆ»ã‚Šã¾ã—ã¦"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

```text 6 subtitle="æœ€å¾Œã«package.jsonã®ä¸­èº«ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™"
â”œâ”€â”€ bin # cdk.jsonã®"app"ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk.ts
â”œâ”€â”€ lib # bin/ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã€‚
â”‚   â””â”€â”€ playground-cdk-stack.ts
â”œâ”€â”€ cdk.json # "app" ã®å†…å®¹ãŒ `npx cdk` ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
â””â”€â”€ package.json
```

</CodeSurferLayout>

---
<CodeSurferLayout>

```json subtitle="ã“ã¡ã‚‰ãŒpackage.jsonã®ä¸­èº«ã§ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "bin": {
    "playground-cdk": "bin/playground-cdk.js"
  },
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 4:6 subtitle="binã®å®šç¾©ãŒã‚ã‚Šã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "bin": {
    "playground-cdk": "bin/playground-cdk.js"
  },
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json subtitle="ã„ã‚‰ãªã„ã®ã§æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 5:6 subtitle="tscã‚’ä½¿ã†scriptãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json subtitle="ã„ã‚‰ãªã„ã®ã§æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 6 subtitle="cdkã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json subtitle="npm run cdk -- deploy ã‚ˆã‚Šã‚‚ npx cdk deploy ã‚’ä½¿ã†ã®ã§æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 20 subtitle="å…ˆç¨‹ä½¿ã‚ãªããªã£ãŸsource-map-supportã‚‚"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

```json 20 subtitle="æ¶ˆã—ã¾ã™"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0"
  }
}
```

```json 1:21 subtitle="ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸ"
{
  "name": "playground-cdk",
  "version": "0.1.0",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "@types/jest": "^27.5.0",
    "@types/node": "10.17.27",
    "@types/prettier": "2.6.0",
    "jest": "^27.5.1",
    "ts-jest": "^27.1.4",
    "aws-cdk": "2.27.0",
    "ts-node": "^10.7.0",
    "typescript": "~3.9.7"
  },
  "dependencies": {
    "aws-cdk-lib": "2.27.0",
    "constructs": "^10.0.0"
  }
}
```

</CodeSurferLayout>
